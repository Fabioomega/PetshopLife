<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bookings</title>
</head>
<body>
  <h1>Listar slots</h1>
  <button onclick="listar_slots()">Listar slots(horários livres)</button>
  <ul id="slot-list"></ul>

  <h1>Listar minha reserva</h1>
  <input id="id_do_usuario_reserva" placeholder="ID do usuario">
  <button onclick="minha_reserva()">Listar minha(s) reserva(s)</button>
  <ul id="minha_reserva"></ul>

  
  <h1>Criar reserva</h1>
  <input id="id_do_usuario" placeholder="ID do usuario">
  <input id="dia_da_semana_reserva" placeholder="Dia da semana">
  <input id="horario_reserva" placeholder="Horario">
  <button onclick="criar_reserva()">Reservar</button>

  <script>
    async function listar_slots() {
      const resp = await fetch("/slots");
      const info = await resp.json();

      // console.log('info' + info);

      const list = document.getElementById("slot-list");
      // console.log('Elemento da lista:', list);
      list.innerHTML = "";

      Object.keys(info).forEach(dia_da_semana => {
        
        const slots = info[dia_da_semana];

        slots.forEach(slot => { 
          if(slot.capacity != 0){
            const li = document.createElement("li");
            li.textContent = `${dia_da_semana} - ${slot.time} (capacidade: ${slot.capacity})`;
            list.appendChild(li);
          }
        })
      });
    }

    async function minha_reserva() {
      const id_do_usuario_reserva = document.getElementById("id_do_usuario_reserva").value;

      const resposta = await fetch(`/bookings/${id_do_usuario_reserva}`);
      const resultado = await resposta.json();
      const list = document.getElementById("minha_reserva");
      console.log('Elemento da lista:', list);
      list.innerHTML = "";
      
      // Verifica se a requisição falhou (status não foi 2xx)
      if (!resposta.ok) {
        // Exibe a mensagem de erro específica vinda da API
        console.error('Erro da API:', resultado);
        alert(`Não foi possível fazer achar a reserva: ${resultado.error}`); // Ex: "Não tem reserva."
        return null;
      }

      resultado.forEach(reserva => {
        console.log('resultado ' + reserva);
        
          const li = document.createElement("li");
          li.textContent = `Reserva do cliente: ${reserva.costumerName}, dia: ${reserva.dayOfWeek}, às: ${reserva.time}, registrado: ${reserva.createdAt}`;
          list.appendChild(li);
      });
    }

    async function criar_reserva() {
      const id_do_usuario = document.getElementById("id_do_usuario").value;
      const dia_da_semana_reserva = document.getElementById("dia_da_semana_reserva").value;
      const horario_reserva = document.getElementById("horario_reserva").value;

      // 1. Monta o objeto com os dados da reserva.
      // As chaves (userId, dayOfWeek, time) devem ser exatamente as mesmas que o back-end espera.
      const dadosDaReserva = {
        userId: id_do_usuario,
        dayOfWeek: dia_da_semana_reserva,
        time: horario_reserva
      };

      try {
        // 2. Faz a requisição POST para a API de bookings
        const resposta = await fetch('/bookings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dadosDaReserva)
        });

        // 3. Pega a resposta do servidor em formato JSON
        const resultado = await resposta.json();

        // 4. Verifica se a requisição falhou (status não foi 2xx)
        if (!resposta.ok) {
          // Exibe a mensagem de erro específica vinda da API
          console.error('Erro da API:', resultado);
          alert(`Não foi possível fazer a reserva: ${resultado.error}`); // Ex: "Usuário não encontrado."
          return null;
        }

        // 5. Se deu tudo certo, exibe a mensagem de sucesso e retorna os dados
        console.log('Sucesso:', resultado);
        alert(resultado.message); // Ex: "Reserva criada com sucesso!"
        listar_slots();
        return resultado.booking;

      } catch (erro) {
        // Captura erros de rede ou de conexão
        console.error('Erro na requisição fetch:', erro);
        alert('Não foi possível conectar ao servidor para fazer a reserva.');
        return null;
      }
    }

  </script>


</body>
</html>
