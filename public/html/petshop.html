<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Petshop</title>
  <style>
        /* Estilização básica para a tabela */
        .tabela-horarios {
            width: 100%;
            border-collapse: collapse;
            font-family: sans-serif;
            margin-bottom: 20px;
        }
        .tabela-horarios th, .tabela-horarios td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .tabela-horarios thead {
            background-color: #B8abd4;
        }
        .tabela-horarios td:first-child {
            font-weight: bold;
            background-color: #B8abd4;
        }
    </style>
</head>
<body>
    
    <h1>Criar slots</h1>
    <select id="dia_da_semana">
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
    </select>
    <select id="horario">
        <option value="08:00">08:00</option>
        <option value="09:00">09:00</option>
        <option value="10:00">10:00</option>
        <option value="11:00">11:00</option>
        <option value="14:00">14:00</option>
        <option value="15:00">15:00</option>
        <option value="16:00">16:00</option>
        <option value="17:00">17:00</option>
    </select>
    <input id="capacidade" placeholder="Capacidade">
    <button onclick="criar_slots()">Criar slots</button>

    <h1>Listar horários</h1>
    <ul id="slot-list"></ul>

    <h1>Listar bookings</h1>
    <button onclick="listar_agendamentos()">Listar agentamentos</button>
    <ul id="bookings-list"></ul>

    <script>
        async function criar_slots() {
            const dia_da_semana = document.getElementById("dia_da_semana").value;
            const horario = document.getElementById("horario").value;
            const capacidade = document.getElementById("capacidade").value;
            
            // 1. Monta o objeto de dados com as chaves que o back-end espera
            const dadosDoSlot = {
                dayOfWeek: dia_da_semana,
                time: horario,
                capacity: capacidade
            };

            try {
                // 2. Faz a requisição para a API
                const resposta = await fetch('/slots', {
                method: 'POST', // O método tem que ser POST
                headers: {
                    'Content-Type': 'application/json' // Avisa que estamos enviando JSON
                },
                body: JSON.stringify(dadosDoSlot) // Converte o objeto para texto JSON
                });

                // 3. Converte a resposta do servidor para JSON
                const resultado = await resposta.json();

                // 4. Verifica se a requisição foi bem-sucedida
                if (!resposta.ok) {
                // Se deu erro, exibe a mensagem de erro da API
                console.error('Erro da API:', resultado);
                alert(`Erro ao criar slot: ${resultado.error || 'Erro desconhecido'}`);
                return null;
                }

                // 5. Se deu tudo certo, exibe a mensagem de sucesso e retorna os dados
                console.log('Sucesso:', resultado);
                alert(resultado.message); // Ex: "Slot criado com sucesso!"
                listar_horarios();
                return resultado.slot;

            } catch (erro) {
                // Captura erros de rede (ex: servidor fora do ar)
                console.error('Erro na requisição fetch:', erro);
                alert('Não foi possível conectar ao servidor.');
                return null;
            }
        }

        async function listar_horarios() {
            const resp = await fetch("/slots");
            const info = await resp.json();

            const list = document.getElementById("slot-list");
            console.log('Elemento da lista:', list);
            list.innerHTML = "";

            table = criarTabelaDeCapacidade(info);
            list.appendChild(table);
        }

        async function listar_agendamentos() {
            const resp = await fetch("/bookings/list");
            const info = await resp.json();

            const list = document.getElementById("bookings-list");
            list.innerHTML = "";

            info.forEach(booking => {
                const li = document.createElement("li");
                li.textContent = `${booking.costumerName} (${booking.phone}): ${booking.dayOfWeek} - ${booking.time}`;
                list.appendChild(li);
            });
        }

        /**
         * Cria uma tabela HTML com base em dados JSON, mostrando a capacidade de cada horário.
         * As colunas são os dias da semana e as linhas são os horários.
         * @param {object} jsonData O objeto JSON com os dados dos agendamentos.
         * @returns {HTMLTableElement} O elemento da tabela HTML criado.
         */
        function criarTabelaDeCapacidade(jsonData) {
            // Define a ordem desejada para os dias da semana
            const diasDaSemana = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            // Coleta todos os horários únicos de todos os dias e os ordena
            const todosOsHorarios = new Set();
            for (const dia in jsonData) {
                if (jsonData.hasOwnProperty(dia)) {
                jsonData[dia].forEach(item => {
                    todosOsHorarios.add(item.time);
                });
                }
            }
            const horariosOrdenados = Array.from(todosOsHorarios).sort();

            // Cria o elemento da tabela e o cabeçalho
            const table = document.createElement('table');
            table.className = 'tabela-horarios'; // Reutilizando a mesma classe para estilização
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            // Adiciona uma célula vazia para o canto superior esquerdo
            const thVazio = document.createElement('th');
            headerRow.appendChild(thVazio);

            // Adiciona os cabeçalhos dos dias da semana
            diasDaSemana.forEach(dia => {
                const th = document.createElement('th');
                th.textContent = dia;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Cria o corpo da tabela com os horários e a capacidade
            const tbody = document.createElement('tbody');
            horariosOrdenados.forEach(horario => {
                const tr = document.createElement('tr');

                // Adiciona a célula com o horário na primeira coluna
                const tdHorario = document.createElement('td');
                tdHorario.textContent = horario;
                tr.appendChild(tdHorario);

                // Itera sobre cada dia da semana para criar as células correspondentes
                diasDaSemana.forEach(dia => {
                const td = document.createElement('td');
                const agendamento = jsonData[dia] ? jsonData[dia].find(item => item.time === horario) : null;

                // *** INÍCIO DA MODIFICAÇÃO ***
                // Se um agendamento for encontrado para este dia e horário,
                // exibe o valor da sua capacidade na célula.
                if (agendamento) {
                    td.textContent = agendamento.capacity;
                }
                // Se nenhum agendamento for encontrado, a célula permanecerá vazia.
                // *** FIM DA MODIFICAÇÃO ***

                tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);

            return table;
        }
        
        listar_horarios();
    </script>

</body>
</html>
